<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Binary Digital - Attendance System</title>
  
  <!-- FAVICON UPDATE (Dengan Cache Buster ?v=3) -->
  <link rel="icon" href="https://www.binarydigiprint.com/wp-content/uploads/2023/08/cropped-binary-logo-revisi-1.png?v=3">
  <link rel="shortcut icon" href="https://www.binarydigiprint.com/wp-content/uploads/2023/08/cropped-binary-logo-revisi-1.png?v=3">
  <link rel="apple-touch-icon" href="https://www.binarydigiprint.com/wp-content/uploads/2023/08/cropped-binary-logo-revisi-1.png?v=3">

  <!-- Manifest untuk PWA -->
  <link rel="manifest" href="manifest.json">

  <!-- Libraries -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Plus+Jakarta+Sans:wght@600;800&display=swap" rel="stylesheet">
  
  <style>
    /* CSS GABUNGAN FINAL */
    body { font-family: 'Inter', sans-serif; background: #f1f5f9; -webkit-tap-highlight-color: transparent; }
    .glass { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); }
    .btn-card { transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; user-select: none; }
    .btn-card:active { transform: scale(0.95); }
    #sheet { transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1); border-radius: 40px 40px 0 0; }
    #overlay { transition: opacity 0.3s ease; }
    
    /* Camera & Animations */
    .camera-box { position: relative; width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 32px; overflow: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
    .face-mask { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 75%; height: 85%; border: 2px dashed rgba(255,255,255,0.5); border-radius: 50% 50% 40% 40%; pointer-events: none; z-index: 10; }
    #photo-preview, #photo-preview-lembur { background-size: cover; background-position: center; z-index: 20; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    .avatar-glow { animation: glow 3s infinite alternate; }
    @keyframes glow { from { box-shadow: 0 0 10px rgba(255,255,255,0.5); } to { box-shadow: 0 0 20px rgba(255,255,255,0.8); } }
  </style>
</head>
<body class="bg-slate-100 min-h-screen flex justify-center">

<div class="w-full max-w-[480px] bg-white min-h-screen relative shadow-2xl overflow-hidden flex flex-col">
  
  <!-- HEADER -->
  <div class="bg-gradient-to-br from-blue-700 via-blue-600 to-indigo-800 p-8 pb-12 rounded-b-[45px] text-white relative z-10 overflow-hidden">
    <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
    
    <div class="flex justify-between items-start mb-6 relative z-10">
      <div class="flex gap-4 items-center">
        <div class="w-14 h-14 bg-white/20 p-1 rounded-full backdrop-blur-md border border-white/30">
          <div class="w-full h-full bg-white rounded-full flex items-center justify-center avatar-glow">
            <img src="https://www.binarydigiprint.com/wp-content/uploads/2023/08/cropped-binary-logo-revisi-1.png" class="w-10 h-10 object-contain">
          </div>
        </div>
        <div>
          <p class="text-[10px] uppercase tracking-[0.25em] text-blue-200 font-bold" id="greet-msg">LOADING...</p>
          <h1 class="text-2xl font-black font-['Plus_Jakarta_Sans'] leading-none">Binary Digital</h1>
        </div>
      </div>
      <div class="text-right">
        <p id="clock" class="text-2xl font-black tracking-tight">00:00</p>
        <p id="date-label" class="text-[10px] font-bold opacity-80 uppercase tracking-widest">---</p>
      </div>
    </div>

    <!-- INFO CARD -->
    <div class="glass rounded-3xl p-5 flex items-center justify-between relative z-10">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-yellow-400 rounded-xl flex items-center justify-center text-xl shadow-lg">üå§Ô∏è</div>
        <div class="overflow-hidden">
          <p class="text-[10px] font-bold text-blue-100 uppercase">EVENT HARI INI</p>
          <p id="event-name" class="text-xs font-bold truncate w-32">Memuat Data...</p>
        </div>
      </div>
      <div class="h-8 w-[1px] bg-white/20"></div>
      <div class="text-right">
        <p class="text-[10px] font-bold text-blue-100 uppercase">GPS LOCATION</p>
        <p id="geo-status" class="text-xs font-bold flex items-center justify-end"><span class="status-dot bg-orange-400"></span>Mencari...</p>
      </div>
    </div>
  </div>

  <!-- MENU GRID -->
  <div class="flex-grow px-6 py-8 relative z-20">
    <div class="text-center mb-6">
      <div class="inline-flex items-center gap-2 bg-blue-50 px-4 py-2 rounded-full">
        <span class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-black">B</span>
        <div class="text-left">
          <p class="text-xs font-black text-gray-800 leading-none">BINARY DIGITAL</p>
          <p class="text-[8px] font-bold text-blue-600 tracking-widest uppercase">Printing Service</p>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div onclick="openForm('IN')" class="btn-card bg-blue-50 border border-blue-100 p-6 rounded-[32px] flex flex-col items-center gap-3 group hover:bg-blue-100">
        <div class="w-14 h-14 bg-blue-600 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-blue-200 group-hover:scale-110 transition-transform">
          <i data-lucide="log-in" class="w-7 h-7"></i>
        </div>
        <p class="text-xs font-bold text-blue-900 tracking-widest">MASUK</p>
      </div>

      <div onclick="openForm('OUT')" class="btn-card bg-orange-50 border border-orange-100 p-6 rounded-[32px] flex flex-col items-center gap-3 group hover:bg-orange-100">
        <div class="w-14 h-14 bg-orange-500 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-orange-200 group-hover:scale-110 transition-transform">
          <i data-lucide="log-out" class="w-7 h-7"></i>
        </div>
        <p class="text-xs font-bold text-orange-900 tracking-widest">PULANG</p>
      </div>

      <div onclick="openForm('IZIN')" class="btn-card bg-purple-50 border border-purple-100 p-6 rounded-[32px] flex flex-col items-center gap-3 group hover:bg-purple-100">
        <div class="w-14 h-14 bg-purple-600 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-purple-200 group-hover:scale-110 transition-transform">
          <i data-lucide="file-clock" class="w-7 h-7"></i>
        </div>
        <p class="text-xs font-bold text-purple-900 tracking-widest">IZIN/CUTI</p>
      </div>

      <div onclick="openForm('LEMBUR')" class="btn-card bg-amber-50 border border-amber-100 p-6 rounded-[32px] flex flex-col items-center gap-3 group hover:bg-amber-100">
        <div class="w-14 h-14 bg-amber-500 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-amber-200 group-hover:scale-110 transition-transform">
          <i data-lucide="zap" class="w-7 h-7"></i>
        </div>
        <p class="text-xs font-bold text-amber-900 tracking-widest">LEMBUR</p>
      </div>
    </div>
  </div>

  <div class="text-center pb-8">
    <p class="text-[10px] text-gray-300 font-bold tracking-widest uppercase">&copy; 2024 Binary Digital Core</p>
  </div>

  <!-- MODAL FORM -->
  <div id="overlay" class="fixed inset-0 bg-black/60 z-40 hidden opacity-0 backdrop-blur-sm" onclick="closeModal()"></div>
  <div id="sheet" class="fixed bottom-0 left-0 right-0 max-w-[480px] mx-auto bg-white z-50 rounded-t-[40px] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] translate-y-full flex flex-col max-h-[90vh]">
    
    <div class="w-full pt-4 pb-2 flex justify-center cursor-grab" onclick="closeModal()">
      <div class="w-16 h-1.5 bg-gray-200 rounded-full"></div>
    </div>

    <div class="overflow-y-auto px-8 pb-8 pt-2">
      <h2 id="sheet-title" class="text-2xl font-black text-gray-800 font-['Plus_Jakarta_Sans']">Form Absensi</h2>
      <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-6">Silahkan lengkapi data</p>

      <div class="space-y-5">
        <!-- Staff -->
        <div>
          <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-2">Nama Staff</label>
          <div class="relative">
            <select id="staff-select" class="w-full bg-gray-50 border-none rounded-2xl p-4 font-bold text-gray-700 focus:ring-2 focus:ring-blue-500 outline-none appearance-none">
              <option value="">Memuat data...</option>
            </select>
            <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none"></i>
          </div>
        </div>

        <!-- Shift -->
        <div id="ui-shift" class="hidden">
          <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-2">Pilih Shift</label>
          <div class="grid grid-cols-2 gap-3">
            <button id="btn-pagi" onclick="setShift('Pagi')" class="p-3 rounded-xl border-2 border-blue-600 bg-blue-600 text-white font-bold text-sm shadow-md transition-all">PAGI</button>
            <button id="btn-siang" onclick="setShift('Siang')" class="p-3 rounded-xl border-2 border-gray-100 bg-gray-50 text-gray-400 font-bold text-sm transition-all">SIANG</button>
          </div>
        </div>

        <!-- Camera -->
        <div id="ui-camera" class="hidden">
          <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-2">Foto Verifikasi</label>
          <div class="camera-box">
            <video id="video" class="w-full h-full object-cover" autoplay playsinline></video>
            <canvas id="canvas" class="hidden"></canvas>
            <div class="face-mask"></div>
            <div id="photo-preview" class="hidden absolute inset-0"></div>
            <button onclick="switchCamera()" class="absolute top-3 right-3 bg-white/20 backdrop-blur p-2 rounded-full text-white"><i data-lucide="refresh-ccw" class="w-5 h-5"></i></button>
          </div>
          <button id="snap-btn" onclick="capturePhoto()" class="mt-3 w-full py-4 bg-gray-900 text-white rounded-2xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
            <i data-lucide="camera" class="w-5 h-5"></i> AMBIL FOTO
          </button>
        </div>

        <!-- IZIN Section -->
        <div id="ui-izin" class="hidden space-y-4">
          <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 text-center">
            <p class="text-xs text-blue-800 font-semibold mb-3">Wajib konfirmasi ke Manajemen via WA</p>
            <button onclick="sendWaIzin()" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-colors">
              <i data-lucide="message-circle" class="w-5 h-5"></i> Chat Pak Reza
            </button>
          </div>

          <div>
            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-2">Jenis Izin</label>
            <select id="izin-type" class="w-full bg-gray-50 border-none rounded-2xl p-4 font-bold text-gray-700 outline-none">
              <option value="">Pilih...</option>
            </select>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-xl">
              <input type="checkbox" id="izin-fullday-check" class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500" checked onchange="toggleIzinMode()">
              <label for="izin-fullday-check" class="text-xs font-bold text-gray-700">FULL DAY</label>
            </div>
            <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-xl">
              <input type="checkbox" id="izin-nonfullday-check" class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500" onchange="toggleIzinMode()">
              <label for="izin-nonfullday-check" class="text-xs font-bold text-gray-700">JAM (Non-Full)</label>
            </div>
          </div>

          <div id="izin-date-group" class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-[9px] font-bold text-gray-400 block mb-1">Mulai</label>
              <input type="date" id="izin-day-start" class="w-full bg-gray-50 p-3 rounded-xl font-bold text-sm border-none outline-none">
            </div>
            <div>
              <label class="text-[9px] font-bold text-gray-400 block mb-1">Selesai</label>
              <input type="date" id="izin-day-end" class="w-full bg-gray-50 p-3 rounded-xl font-bold text-sm border-none outline-none">
            </div>
          </div>
          <p id="izin-total-hari" class="text-center text-xs font-bold text-purple-600"></p>

          <div id="izin-time-group" class="grid grid-cols-2 gap-3 hidden">
            <div>
              <label class="text-[9px] font-bold text-gray-400 block mb-1">Jam Mulai</label>
              <input type="time" id="izin-time-start" class="w-full bg-gray-50 p-3 rounded-xl font-bold text-sm border-none outline-none">
            </div>
            <div>
              <label class="text-[9px] font-bold text-gray-400 block mb-1">Jam Selesai</label>
              <input type="time" id="izin-time-end" class="w-full bg-gray-50 p-3 rounded-xl font-bold text-sm border-none outline-none">
            </div>
          </div>
          <p id="izin-total-jam" class="text-center text-xs font-bold text-purple-600 hidden"></p>

          <textarea id="izin-detail" placeholder="Jelaskan alasan izin..." class="w-full bg-gray-50 p-4 rounded-2xl h-24 font-semibold text-sm border-none outline-none resize-none"></textarea>

          <div>
            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-2">Upload Bukti Chat WA</label>
            <div id="izin-upload-box" class="border-2 border-dashed border-purple-200 bg-purple-50 h-32 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:bg-purple-100 transition-colors relative">
              <i data-lucide="image-plus" class="w-8 h-8 text-purple-400 mb-2"></i>
              <span class="text-xs text-purple-600 font-bold">Tap untuk Upload</span>
              <input type="file" id="izin-file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
            </div>
            <img id="izin-preview-img" class="hidden w-full h-40 object-contain mt-2 rounded-xl bg-gray-100 border">
          </div>
        </div>

        <!-- LEMBUR Section -->
        <div id="ui-lembur" class="hidden space-y-4">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-[9px] font-bold text-gray-400 block mb-1">Jam Mulai</label>
              <input type="time" id="lembur-start" class="w-full bg-gray-50 p-3 rounded-xl font-bold text-2xl text-center border-none outline-none">
            </div>
            <div>
              <label class="text-[9px] font-bold text-gray-400 block mb-1">Jam Selesai</label>
              <input type="time" id="lembur-end" class="w-full bg-gray-50 p-3 rounded-xl font-bold text-2xl text-center border-none outline-none">
            </div>
          </div>
          
          <div>
            <label class="text-[9px] font-bold text-gray-400 block mb-1">Tanggal Lembur</label>
            <input type="date" id="lembur-day" class="w-full bg-gray-50 p-3 rounded-xl font-bold text-center border-none outline-none">
          </div>

          <div>
            <label class="text-[9px] font-bold text-gray-400 block mb-1">Deskripsi Pekerjaan</label>
            <textarea id="lembur-desc" class="w-full bg-gray-50 p-3 rounded-xl font-semibold text-sm border-none outline-none h-20 resize-none"></textarea>
          </div>

          <div class="bg-amber-50 p-4 rounded-xl border border-amber-100 text-center">
            <span class="text-[10px] text-amber-800 font-bold uppercase tracking-widest">Durasi Lembur</span>
            <p id="lembur-total" class="text-2xl font-black text-amber-600 mt-1">0 jam 0 menit</p>
          </div>

          <div id="ui-lembur-surat">
            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-2">Foto Surat Tugas</label>
            <div class="camera-box">
              <video id="video-lembur" class="w-full h-full object-cover" autoplay playsinline></video>
              <canvas id="canvas-lembur" class="hidden"></canvas>
              <div class="absolute inset-4 border-2 border-dashed border-cyan-400 rounded-lg pointer-events-none opacity-70"></div>
              <div id="photo-preview-lembur" class="hidden absolute inset-0"></div>
              <button onclick="switchCameraLembur()" class="absolute top-3 right-3 bg-white/20 backdrop-blur p-2 rounded-full text-white"><i data-lucide="refresh-ccw" class="w-5 h-5"></i></button>
            </div>
            <button id="snap-btn-lembur" onclick="capturePhotoLembur()" class="mt-3 w-full py-4 bg-gray-900 text-white rounded-2xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">
              <i data-lucide="camera" class="w-5 h-5"></i> FOTO SURAT
            </button>
          </div>
        </div>

        <!-- Submit -->
        <div class="pt-4 pb-8">
          <button onclick="submitData()" class="w-full py-5 bg-blue-600 text-white rounded-[20px] font-black text-lg shadow-xl shadow-blue-200 active:scale-95 transition-transform">
            KIRIM DATA
          </button>
          <button onclick="closeModal()" class="w-full mt-3 py-3 text-gray-400 font-bold text-xs uppercase tracking-widest">
            Batal
          </button>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- LOGIC -->
<script>
// --- URL WEBAPP YANG BARU ---
const APPSCRIPT_URL = "https://script.google.com/macros/s/AKfycbxeVKs3Uai_gakqBFYiYg5-wahixtSqHyuXUhalbG2BUwOzW8uuI8JWMmSQa1FbMBu-/exec";

let currentState = { mode: null, shift: 'Pagi', photoSelfie: null, photoSurat: null, izinBukti: null, location: "Mencari...", camStream: null, camFacing: 'user' };

document.addEventListener('DOMContentLoaded', () => {
  try { lucide.createIcons(); } catch(e){}
  startClock();
  getLocation();
  fetchInitialData();
  setupIzinListeners();
  setupLemburListeners();
});

function startClock() {
  setInterval(() => {
    const now = new Date();
    document.getElementById('clock').innerText = now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit', hour12:false});
    document.getElementById('date-label').innerText = now.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
    const h = now.getHours();
    document.getElementById('greet-msg').innerText = h < 11 ? "Selamat Pagi" : h < 15 ? "Selamat Siang" : h < 19 ? "Selamat Sore" : "Selamat Malam";
  }, 1000);
}

async function callApi(command, payload = {}, extra = {}) {
  try {
    const res = await fetch(APPSCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ command, payload, ...extra }),
      headers: { "Content-Type": "text/plain;charset=utf-8" }
    });
    return await res.json();
  } catch (e) { return { error: "Gagal koneksi server" }; }
}

async function fetchInitialData() {
  const staffSel = document.getElementById('staff-select');
  try {
    const data = await callApi('getInitialData');
    if (data.staffList) {
      staffSel.innerHTML = '<option value="">Pilih Nama Anda...</option>';
      data.staffList.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.text = s; staffSel.add(opt); });
    }
    if (data.izinReasons) {
      const izinSel = document.getElementById('izin-type');
      izinSel.innerHTML = '<option value="">Pilih Jenis Izin...</option>';
      data.izinReasons.forEach(r => { const opt = document.createElement('option'); opt.value = r; opt.text = r; izinSel.add(opt); });
    }
    if (data.events && data.events.length > 0) {
      const today = new Date().toLocaleDateString('en-US', {month:'2-digit', day:'2-digit'});
      const ev = data.events.find(e => e.date == today);
      if(ev) document.getElementById('event-name').innerText = ev.name;
    }
  } catch(e) { staffSel.innerHTML = '<option>Gagal memuat (Offline)</option>'; }
}

function getLocation() {
  if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(async (pos) => {
      const coords = pos.coords.latitude + "," + pos.coords.longitude;
      const res = await callApi('geo', {}, { coords });
      currentState.location = (res && typeof res === 'string') ? res : coords;
      document.getElementById('geo-status').innerHTML = '<span class="status-dot bg-green-400"></span>Terverifikasi';
    }, () => {
      currentState.location = "GPS OFF";
      document.getElementById('geo-status').innerHTML = '<span class="status-dot bg-red-400"></span>GPS Mati';
    });
  }
}

window.openForm = (mode) => {
  currentState.mode = mode;
  document.getElementById('sheet-title').innerText = mode === 'IN' ? 'Absen Masuk' : mode === 'OUT' ? 'Absen Pulang' : mode === 'IZIN' ? 'Form Izin' : 'Form Lembur';
  
  const show = (id, visible) => document.getElementById(id).classList.toggle('hidden', !visible);
  show('ui-shift', mode === 'IN' || mode === 'OUT');
  show('ui-camera', mode === 'IN' || mode === 'OUT');
  show('ui-izin', mode === 'IZIN');
  show('ui-lembur', mode === 'LEMBUR');

  if(mode === 'IN' || mode === 'OUT') startCamera('video'); else stopCamera();
  if(mode === 'LEMBUR') { startCamera('video-lembur', 'environment'); resetLemburForm(); }

  const overlay = document.getElementById('overlay');
  const sheet = document.getElementById('sheet');
  overlay.classList.remove('hidden');
  setTimeout(() => overlay.classList.remove('opacity-0'), 10);
  setTimeout(() => sheet.classList.remove('translate-y-full'), 10);
};

window.closeModal = () => {
  const overlay = document.getElementById('overlay');
  const sheet = document.getElementById('sheet');
  sheet.classList.add('translate-y-full');
  overlay.classList.add('opacity-0');
  setTimeout(() => { overlay.classList.add('hidden'); stopCamera(); }, 300);
};

async function startCamera(videoId, facing = 'user') {
  stopCamera();
  currentState.camFacing = facing;
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facing } });
    currentState.camStream = stream;
    document.getElementById(videoId).srcObject = stream;
  } catch(e) { console.warn("Camera Fail", e); }
}

function stopCamera() {
  if(currentState.camStream) { currentState.camStream.getTracks().forEach(t => t.stop()); currentState.camStream = null; }
}

window.switchCamera = () => startCamera('video', currentState.camFacing === 'user' ? 'environment' : 'user');
window.switchCameraLembur = () => startCamera('video-lembur', currentState.camFacing === 'user' ? 'environment' : 'user');

window.capturePhoto = () => {
  const vid = document.getElementById('video');
  const can = document.getElementById('canvas');
  if(!vid.srcObject) return;
  can.width = vid.videoWidth; can.height = vid.videoHeight;
  can.getContext('2d').drawImage(vid, 0, 0);
  addWatermark(can);
  currentState.photoSelfie = can.toDataURL('image/jpeg', 0.8);
  const prev = document.getElementById('photo-preview');
  prev.style.backgroundImage = `url(${currentState.photoSelfie})`;
  prev.classList.remove('hidden');
  document.getElementById('snap-btn').innerHTML = "FOTO OKE ‚úì";
  document.getElementById('snap-btn').classList.add('bg-green-600');
};

window.capturePhotoLembur = () => {
  const vid = document.getElementById('video-lembur');
  const can = document.getElementById('canvas-lembur');
  if(!vid.srcObject) return;
  can.width = vid.videoWidth; can.height = vid.videoHeight;
  can.getContext('2d').drawImage(vid, 0, 0);
  currentState.photoSurat = can.toDataURL('image/jpeg', 0.8);
  const prev = document.getElementById('photo-preview-lembur');
  prev.style.backgroundImage = `url(${currentState.photoSurat})`;
  prev.classList.remove('hidden');
  document.getElementById('snap-btn-lembur').innerHTML = "SURAT OKE ‚úì";
  document.getElementById('snap-btn-lembur').classList.add('bg-green-600');
};

function addWatermark(canvas) {
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = "rgba(0,0,0,0.5)";
  ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
  ctx.fillStyle = "white";
  ctx.font = "bold 24px Arial";
  ctx.fillText(new Date().toLocaleString('id-ID'), 20, canvas.height - 18);
}

window.setShift = (s) => {
  currentState.shift = s;
  const active = "border-blue-600 bg-blue-600 text-white shadow-md";
  const inactive = "border-gray-100 bg-gray-50 text-gray-400";
  document.getElementById('btn-pagi').className = "p-3 rounded-xl border-2 font-bold text-sm transition-all " + (s === 'Pagi' ? active : inactive);
  document.getElementById('btn-siang').className = "p-3 rounded-xl border-2 font-bold text-sm transition-all " + (s === 'Siang' ? active : inactive);
};

function setupIzinListeners() {
  const fileIn = document.getElementById('izin-file');
  document.getElementById('izin-upload-box').onclick = () => fileIn.click();
  fileIn.onchange = (e) => {
    const file = e.target.files[0];
    if(file) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        document.getElementById('izin-preview-img').src = ev.target.result;
        document.getElementById('izin-preview-img').classList.remove('hidden');
        currentState.izinBukti = ev.target.result;
      };
      reader.readAsDataURL(file);
    }
  };
}

window.toggleIzinMode = () => {
  const full = document.getElementById('izin-fullday-check');
  const non = document.getElementById('izin-nonfullday-check');
  if(event.target === full && full.checked) non.checked = false;
  if(event.target === non && non.checked) full.checked = false;
  const isFull = full.checked;
  document.getElementById('izin-date-group').classList.toggle('hidden', !isFull);
  document.getElementById('izin-total-hari').classList.toggle('hidden', !isFull);
  document.getElementById('izin-time-group').classList.toggle('hidden', isFull);
  document.getElementById('izin-total-jam').classList.toggle('hidden', isFull);
};

document.getElementById('izin-day-end').addEventListener('change', () => {
  const d1 = new Date(document.getElementById('izin-day-start').value);
  const d2 = new Date(document.getElementById('izin-day-end').value);
  if(d1 && d2) {
    const diff = Math.floor((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;
    document.getElementById('izin-total-hari').innerText = diff > 0 ? `Total: ${diff} Hari` : "Tanggal tidak valid";
  }
});

function setupLemburListeners() {
  const calc = () => {
    const s = document.getElementById('lembur-start').value;
    const e = document.getElementById('lembur-end').value;
    if(s && e) {
      const [sh, sm] = s.split(':').map(Number);
      const [eh, em] = e.split(':').map(Number);
      let m = (eh * 60 + em) - (sh * 60 + sm);
      if(m < 0) m += 24*60;
      document.getElementById('lembur-total').innerText = `${Math.floor(m/60)} jam ${m%60} menit`;
    }
  };
  document.getElementById('lembur-start').onchange = calc;
  document.getElementById('lembur-end').onchange = calc;
}

function resetLemburForm() {
  document.getElementById('lembur-start').value = "";
  document.getElementById('lembur-end').value = "";
  document.getElementById('lembur-desc').value = "";
  document.getElementById('lembur-total').innerText = "0 jam 0 menit";
  currentState.photoSurat = null;
  document.getElementById('photo-preview-lembur').classList.add('hidden');
  document.getElementById('snap-btn-lembur').innerHTML = "FOTO SURAT";
  document.getElementById('snap-btn-lembur').classList.remove('bg-green-600');
}

window.sendWaIzin = () => {
  const name = document.getElementById('staff-select').value || "[NAMA]";
  const text = `Assalamualaikum Pak Reza, Nama saya ${name}, Saya Mohon Izin mengajukan Izin/Cuti. Mohon konfirmasinya. Terima kasih.`;
  window.open(`https://wa.me/+6281280774886?text=${encodeURIComponent(text)}`, '_blank');
};

window.submitData = async () => {
  const staff = document.getElementById('staff-select').value;
  if(!staff) return Swal.fire('Error', 'Pilih nama Anda dulu', 'error');
  const payload = { action: currentState.mode, staff };

  if (currentState.mode === 'IN' || currentState.mode === 'OUT') {
    if(!currentState.photoSelfie) return Swal.fire('Error', 'Foto Wajah Wajib!', 'warning');
    payload.photo = currentState.photoSelfie;
    payload.shift = currentState.shift;
    payload.location = currentState.location;
  }
  else if (currentState.mode === 'IZIN') {
    const isFull = document.getElementById('izin-fullday-check').checked;
    if(!currentState.izinBukti) return Swal.fire('Error', 'Bukti WA Wajib Upload!', 'warning');
    payload.reasonType = document.getElementById('izin-type').value;
    payload.izinMode = isFull ? 'FULLDAY' : 'NONFULLDAY';
    payload.detail = document.getElementById('izin-detail').value;
    payload.izinBukti = currentState.izinBukti;
    if(isFull) {
      payload.izinDayStart = document.getElementById('izin-day-start').value;
      payload.izinDayEnd = document.getElementById('izin-day-end').value;
      payload.izinTotalHari = document.getElementById('izin-total-hari').innerText;
    } else {
      payload.izinTimeStart = document.getElementById('izin-time-start').value;
      payload.izinTimeEnd = document.getElementById('izin-time-end').value;
      payload.izinTotalJam = document.getElementById('izin-total-jam').innerText;
    }
  }
  else if (currentState.mode === 'LEMBUR') {
    if(!currentState.photoSurat) return Swal.fire('Error', 'Foto Surat Wajib!', 'warning');
    payload.lemburStart = document.getElementById('lembur-start').value;
    payload.lemburEnd = document.getElementById('lembur-end').value;
    payload.lemburDay = document.getElementById('lembur-day').value;
    payload.lemburDesc = document.getElementById('lembur-desc').value;
    payload.hours = document.getElementById('lembur-total').innerText;
    payload.lemburSurat = currentState.photoSurat;
    payload.location = currentState.location;
  }

  Swal.fire({ title: 'Mengirim Data...', didOpen: () => Swal.showLoading() });
  const res = await callApi('submit', payload);
  
  if(res && (res.success || res.izinBuktiUrl)) {
    Swal.fire('Berhasil', 'Data tersimpan!', 'success');
    closeModal();
  } else {
    Swal.fire('Gagal', res.error || 'Server error', 'error');
  }
};
</script>
</body>
</html>
